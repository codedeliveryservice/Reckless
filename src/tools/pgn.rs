use std::{
    fs::File,
    io::{BufReader, BufWriter, Read},
    sync::{Arc, Mutex},
};

use indicatif::{ProgressBar, ProgressStyle};
use pgn_lexer::parser::{PGNTokenIterator, Token};
use shakmaty::{fen::Fen, san::San, CastlingMode, Chess, Position};

use crate::{board::Board, nnue::Network, tools::BinpackWriter};

const IDS: &[usize] = &[
    7001, 7003, 7004, 7005, 7006, 7009, 7010, 7011, 7012, 7013, 7014, 7015, 7022, 7023, 7027, 7028, 7029, 7030, 7031,
    7032, 7033, 7037, 7038, 7040, 7043, 7045, 7046, 7047, 7048, 7049, 7050, 7051, 7052, 7053, 7054, 7058, 7060, 7063,
    7064, 7065, 7066, 7067, 7068, 7069, 7070, 7072, 7073, 7075, 7077, 7078, 7080, 7082, 7083, 7084, 7086, 7089, 7090,
    7091, 7092, 7096, 7097, 7098, 7103, 7104, 7105, 7106, 7107, 7108, 7110, 7111, 7112, 7113, 7115, 7116, 7117, 7122,
    7123, 7124, 7125, 7126, 7128, 7129, 7130, 7132, 7133, 7134, 7135, 7136, 7137, 7138, 7140, 7141, 7142, 7143, 7144,
    7145, 7147, 7148, 7149, 7150, 7151, 7152, 7162, 7164, 7166, 7168, 7171, 7172, 7173, 7174, 7175, 7177, 7181, 7195,
    7196, 7197, 7198, 7199, 7200, 7201, 7209, 7210, 7211, 7212, 7219, 7221, 7225, 7226, 7230, 7231, 7232, 7233, 7236,
    7237, 7240, 7241, 7242, 7244, 7248, 7249, 7250, 7252, 7253, 7256, 7257, 7259, 7260, 7261, 7262, 7263, 7265, 7267,
    7268, 7269, 7270, 7275, 7276, 7277, 7278, 7279, 7281, 7283, 7285, 7286, 7290, 7291, 7292, 7293, 7295, 7296, 7297,
    7298, 7299, 7300, 7301, 7302, 7303, 7305, 7306, 7307, 7308, 7309, 7310, 7311, 7312, 7313, 7315, 7316, 7317, 7318,
    7326, 7327, 7328, 7329, 7330, 7331, 7332, 7333, 7334, 7335, 7337, 7339, 7340, 7341, 7344, 7349, 7350, 7351, 7352,
    7353, 7354, 7356, 7357, 7358, 7359, 7360, 7361, 7362, 7363, 7364, 7365, 7366, 7367, 7368, 7369, 7370, 7376, 7377,
    7378, 7379, 7380, 7382, 7383, 7384, 7385, 7387, 7388, 7390, 7391, 7393, 7394, 7395, 7396, 7398, 7399, 7400, 7403,
    7404, 7405, 7406, 7407, 7408, 7413, 7424, 7425, 7427, 7428, 7429, 7438, 7439, 7441, 7443, 7444, 7445, 7446, 7447,
    7449, 7450, 7452, 7453, 7455, 7456, 7457, 7458, 7491, 7492, 7493, 7495, 7496, 7497, 7498, 7499, 7503, 7504, 7508,
    7509, 7510, 7511, 7512, 7513, 7514, 7515, 7517, 7518, 7519, 7520, 7523, 7524, 7525, 7526, 7531, 7532, 7533, 7536,
    7537, 7538, 7539, 7540, 7542, 7543, 7544, 7545, 7546, 7548, 7551, 7552, 7553, 7555, 7556, 7559, 7561, 7562, 7566,
    7567, 7568, 7569, 7570, 7571, 7572, 7573, 7580, 7581, 7582, 7583, 7584, 7588, 7589, 7590, 7591, 7592, 7593, 7594,
    7595, 7596, 7597, 7599, 7601, 7603, 7604, 7605, 7606, 7608, 7609, 7610, 7611, 7614, 7615, 7617, 7621, 7624, 7631,
    7632, 7633, 7635, 7638, 7639, 7640, 7641, 7642, 7643, 7645, 7646, 7652, 7653, 7656, 7658, 7659, 7660, 7661, 7663,
    7664, 7667, 7668, 7669, 7670, 7671, 7672, 7673, 7677, 7678, 7679, 7683, 7684, 7685, 7686, 7688, 7689, 7690, 7691,
    7692, 7693, 7694, 7695, 7697, 7703, 7704, 7705, 7707, 7708, 7709, 7710, 7711, 7712, 7713, 7714, 7715, 7716, 7718,
    7719, 7720, 7721, 7726, 7727, 7728, 7729, 7731, 7733, 7734, 7735, 7736, 7737, 7738, 7739, 7740, 7741, 7743, 7744,
    7745, 7746, 7747, 7749, 7750, 7751, 7752, 7753, 7754, 7755, 7756, 7757, 7758, 7759, 7760, 7761, 7762, 7763, 7764,
    7765, 7769, 7770, 7773, 7776, 7777, 7778, 7789, 7790, 7792, 7794, 7795, 7796, 7798, 7800, 7805, 7807, 7808, 7809,
    7810, 7811, 7812, 7814, 7815, 7817, 7819, 7824, 7825, 7826, 7828, 7829, 7830, 7831, 7833, 7834, 7835, 7836, 7838,
    7839, 7840, 7841, 7842, 7843, 7844, 7845, 7848, 7849, 7850, 7851, 7852, 7853, 7854, 7855, 7856, 7857, 7858, 7859,
    7860, 7861, 7866, 7867, 7868, 7869, 7870, 7872, 7873, 7874, 7875, 7876, 7877, 7878, 7879, 7880, 7881, 7882, 7884,
    7886, 7892, 7893, 7895, 7896, 7897, 7898, 7899, 7900, 7901, 7903, 7904, 7905, 7907, 7909, 7910, 7911, 7912, 7914,
    7915, 7916, 7917, 7918, 7919, 7921, 7922, 7923, 7924, 7925, 7926, 7927, 7928, 7929, 7930, 7931, 7932, 7933, 7934,
    7936, 7937, 7939, 7940, 7941, 7942, 7946, 7947, 7948, 7949, 7950, 7951, 7952, 7953, 7954, 7956, 7957, 7958, 7959,
    7961, 7962, 7966, 7967, 7968, 7969, 7970, 7971, 7974, 7975, 7976, 7977, 7978, 7979, 7980, 7984, 7986, 7987, 7988,
    7989, 7990, 7991, 7992, 7993, 7994, 7995, 7996, 7997, 7998, 8000, 8001, 8003, 8006, 8009, 8011, 8012, 8013, 8015,
    8016, 8017, 8018, 8022, 8023, 8024, 8025, 8026, 8029, 8030, 8031, 8035, 8037, 8038, 8039, 8045, 8046, 8047, 8048,
    8049, 8050, 8051, 8052, 8053, 8054, 8055, 8057, 8058, 8059, 8060, 8061, 8062, 8063, 8064, 8065, 8066, 8068, 8069,
    8070, 8071, 8072, 8073, 8074, 8075, 8080, 8081, 8082, 8083, 8084, 8086, 8088, 8089, 8090, 8091, 8092, 8094, 8095,
    8096, 8097, 8098, 8101, 8104, 8105, 8106, 8107, 8108, 8112, 8113, 8115, 8118, 8119, 8121, 8122, 8125, 8127, 8129,
    8131, 8132, 8135, 8136, 8137, 8150, 8151, 8152, 8157, 8160, 8161, 8164, 8168, 8169, 8170, 8172, 8173, 8174, 8176,
    8181, 8191, 8192, 8193, 8194, 8196, 8198, 8199, 8202, 8203, 8209, 8210, 8211, 8219, 8225, 8226, 8227, 8228, 8229,
    8231, 8232, 8241, 8244, 8246, 8248, 8254, 8256, 8268, 8271, 8276, 8277, 8278, 8279, 8280, 8281, 8282, 8283, 8284,
    8285, 8286, 8288, 8289, 8290, 8291, 8292, 8293, 8294, 8295, 8296, 8297, 8298, 8299, 8301, 8302, 8304, 8305, 8306,
    8307, 8309, 8310, 8311, 8312, 8313, 8321, 8322, 8323, 8324, 8325, 8326, 8331, 8332, 8333, 8334, 8335, 8336, 8337,
    8338, 8339, 8340, 8341, 8342, 8343, 8344, 8345, 8346, 8347, 8348, 8349, 8353, 8356, 8361, 8362, 8365, 8367, 8376,
    8377, 8378, 8379, 8390, 8392, 8394, 8398, 8399, 8401, 8402, 8407, 8414, 8417, 8447, 8448, 8449, 8450, 8451, 8452,
    8453, 8454, 8455, 8456, 8457, 8458, 8461, 8463, 8464, 8476, 8477, 8480, 8483, 8500, 8506, 8513, 8518, 8524, 8525,
    8526, 8528, 8529, 8532, 8533, 8534, 8535, 8536, 8538, 8539, 8540, 8542, 8543, 8544, 8545, 8546, 8547, 8548, 8549,
    8550, 8553, 8554, 8555, 8557, 8558, 8559, 8560, 8561, 8562, 8563, 8564, 8565, 8566, 8567, 8568, 8569, 8570, 8571,
    8572, 8573, 8574, 8575, 8579, 8580, 8581, 8582, 8583, 8584, 8585, 8598, 8599, 8602, 8603, 8604, 8605, 8607, 8608,
    8609, 8610, 8611, 8612, 8613, 8615, 8616, 8617, 8619, 8620, 8621, 8622, 8623, 8624, 8625, 8627, 8628, 8630, 8631,
    8632, 8633, 8634, 8635, 8636, 8637, 8638, 8639, 8640, 8641, 8642, 8643, 8644, 8645, 8646, 8647, 8649, 8650, 8652,
    8653, 8654, 8656, 8657, 8658, 8660, 8661, 8662, 8663, 8664, 8665, 8666, 8667, 8669, 8670, 8671, 8672, 8673, 8674,
    8675, 8676, 8677, 8678, 8680, 8681, 8682, 8685, 8687, 8694, 8695, 8696, 8697, 8698, 8700, 8701, 8704, 8705, 8706,
    8707, 8710, 8711, 8734, 8735, 8743, 8748, 8750, 8760, 8770, 8771, 8772, 8776, 8778, 8788, 8789, 8793, 8796, 8801,
    8803, 8819, 8820, 8823, 8824, 8826, 8828, 8830, 8831, 8832, 8833, 8835, 8836, 8840, 8841, 8842, 8845, 8846, 8847,
    8848, 8850, 8852, 8853, 8854, 8856, 8857, 8859, 8863, 8864, 8865, 8866, 8867, 8868, 8869, 8870, 8872, 8873, 8874,
    8875, 8878, 8879, 8880, 8881, 8883, 8884, 8885, 8886, 8887, 8888, 8889, 8890, 8891, 8893, 8895, 8897, 8898, 8899,
    8900, 8901, 8902, 8903, 8904, 8905, 8906, 8907, 8908, 8909, 8910, 8911, 8913, 8914, 8915, 8916, 8917, 8918, 8919,
    8922, 8923, 8924, 8925, 8926, 8927, 8930, 8931, 8932, 8933, 8935, 8936, 8937, 8938, 8939, 8940, 8941, 8943, 8944,
    8945, 8947, 8948, 8949, 8950, 8953, 8954, 8955, 8956, 8957, 8958, 8959, 8960, 8961, 8962, 8963, 8964, 8965, 8966,
    8968, 8969, 8972, 8973, 8974, 8980, 8984, 8985, 8986, 8987, 8988, 8990, 8992, 8993, 8994, 8995, 8996, 8997, 8998,
    8999, 9001, 9002, 9003, 9004, 9006, 9007, 9012, 9014, 9016, 9019, 9020, 9023, 9024, 9026, 9027, 9029, 9031, 9032,
    9033, 9034, 9035, 9036, 9037, 9041, 9044, 9046, 9048, 9050, 9052, 9056, 9057, 9058, 9059, 9060, 9061, 9062, 9063,
    9071, 9072, 9074, 9075, 9076, 9077, 9079, 9081, 9082, 9084, 9085, 9086, 9104, 9106, 9107, 9108, 9109, 9112, 9113,
    9114, 9116, 9117, 9118, 9121, 9122, 9125, 9126, 9127, 9128, 9129, 9130, 9131, 9133, 9135, 9136, 9137, 9138, 9139,
    9140, 9141, 9145, 9146, 9147, 9148, 9149, 9150, 9151, 9152, 9153, 9154, 9155, 9156, 9157, 9158, 9160, 9161, 9162,
    9164, 9165, 9166, 9167, 9168, 9169, 9170, 9172, 9173, 9174, 9175, 9177, 9178, 9179, 9180, 9181, 9182, 9183, 9185,
    9186, 9187, 9188, 9189, 9190, 9191, 9192, 9193, 9194, 9195, 9196, 9197, 9198, 9199, 9200, 9202, 9204, 9205, 9207,
    9208, 9209, 9210, 9211, 9212, 9213, 9214, 9215, 9217, 9218, 9220, 9223, 9224, 9227, 9228, 9229, 9230, 9231, 9233,
    9234, 9237, 9238, 9241, 9242, 9243, 9244, 9245, 9246, 9247, 9248, 9249, 9250, 9251, 9252, 9256, 9259, 9260, 9261,
    9262, 9265, 9266, 9268, 9269, 9270, 9271, 9272, 9273, 9274, 9275, 9276, 9277, 9278, 9280, 9284, 9285, 9286, 9291,
    9292, 9293, 9294, 9296, 9297, 9299, 9302, 9303, 9304, 9305, 9306, 9307, 9310, 9313, 9315, 9316, 9317, 9318, 9321,
    9322, 9323, 9325, 9326, 9327, 9332, 9333, 9334, 9335, 9336, 9337, 9338, 9339, 9341, 9342, 9345, 9346, 9348, 9349,
    9350, 9351, 9352, 9353, 9354, 9355, 9356, 9357, 9358, 9361, 9365, 9366, 9367, 9368, 9369, 9371, 9372, 9373, 9374,
    9375, 9376, 9378, 9379, 9380, 9381, 9382, 9383, 9384, 9385, 9386, 9387, 9388, 9389, 9390, 9392, 9393, 9394, 9395,
    9396, 9397, 9398, 9399, 9400, 9401, 9402, 9403, 9404, 9406, 9407, 9408, 9409, 9410, 9411, 9412, 9417, 9418, 9419,
    9420, 9421, 9422, 9423, 9424, 9425, 9427, 9428, 9429, 9430, 9431, 9432, 9435, 9438, 9439, 9443, 9444, 9452, 9454,
    9455, 9459, 9460, 9462, 9465, 9466, 9467, 9468, 9469, 9471, 9472, 9473, 9474, 9475, 9478, 9480, 9483, 9484, 9486,
    9487, 9491, 9493, 9495, 9498, 9499, 9500, 9501, 9503, 9506, 9508, 9509, 9511, 9512, 9513, 9514, 9515, 9516, 9517,
    9518, 9520, 9521, 9525, 9526, 9527, 9530, 9531, 9533, 9535, 9536, 9537, 9539, 9540, 9541, 9542, 9543, 9544, 9547,
    9549, 9551, 9552, 9554, 9555, 9556, 9562, 9563, 9566, 9567, 9568, 9569, 9571, 9572, 9573, 9574, 9576, 9577, 9578,
    9581, 9582, 9583, 9585, 9587, 9590, 9591, 9594, 9595, 9597, 9598, 9599, 9600, 9601, 9602, 9603, 9604, 9605, 9607,
    9609, 9611, 9612, 9613, 9614, 9615, 9616, 9617, 9618, 9619, 9621, 9622, 9623, 9624, 9625, 9626, 9627, 9628, 9629,
    9631, 9632, 9633, 9634, 9636, 9637, 9638, 9639, 9640, 9641, 9642, 9643, 9644, 9645, 9646, 9648, 9649, 9650, 9651,
    9652, 9653, 9654, 9655, 9656, 9657, 9658, 9660, 9664, 9666, 9667, 9668, 9669, 9671, 9673, 9675, 9678, 9679, 9680,
    9684, 9686, 9687, 9688, 9692, 9693, 9694, 9695, 9696, 9697, 9699, 9700, 9702, 9703, 9704, 9706, 9707, 9711, 9712,
    9713, 9714, 9715, 9716, 9717, 9719, 9728, 9730, 9731, 9732, 9734, 9736, 9737, 9738, 9739, 9740, 9743, 9744, 9745,
    9746, 9754, 9755, 9756, 9757, 9768, 9769, 9772, 9773, 9774, 9776, 9777, 9778, 9779, 9780, 9781, 9782, 9783, 9800,
    9801, 9802, 9807, 9812, 9814, 9816, 9817, 9820, 9821, 9822, 9823, 9824, 9826, 9827, 9828, 9830, 9833, 9834, 9835,
    9837, 9838, 9840, 9841, 9842, 9843, 9846, 9847, 9848, 9849, 9850, 9853, 9854, 9855, 9856, 9857, 9859, 9860, 9861,
    9862, 9863, 9864, 9866, 9868, 9869, 9871, 9872, 9873, 9875, 9876, 9878, 9879, 9883, 9885, 9886, 9887, 9888, 9890,
    9891, 9892, 9894, 9895, 9896, 9898, 9899, 9900, 9901, 9902, 9903, 9907, 9908, 9909, 9910, 9911, 9912, 9913, 9914,
    9915, 9919, 9920, 9921, 9922, 9923, 9924,
];

pub fn convert_pgns(input: &str, output: &str, threads: usize) {
    println!("Converting PGNs from '{input}' to '{output}' using {threads} threads [adversarial=full]");

    let mut handlers = Vec::new();

    std::fs::create_dir(output).unwrap();

    let mut files = std::fs::read_dir(input)
        .unwrap()
        .flatten()
        .map(|entry| entry.path().to_string_lossy().to_string())
        .filter(|file_name| IDS.iter().any(|id| file_name.contains(&id.to_string())))
        .collect::<Vec<_>>();

    println!("Found {} files to convert", files.len());

    files.sort_by_key(|f| std::fs::metadata(f).unwrap().len());
    files.reverse();

    let bar = ProgressBar::new(files.len() as u64).with_style(
        ProgressStyle::with_template("{spinner:.green} [{bar:40}] {pos}/{len} ({eta}) {percent}%")
            .unwrap()
            .progress_chars("=> "),
    );

    let progress = Arc::new(Mutex::new(bar));

    let mut chunks = vec![Vec::new(); threads];
    for (i, item) in files.into_iter().enumerate() {
        chunks[i % threads].push(item);
    }

    for (index, chunk) in chunks.iter().enumerate() {
        let chunk = chunk.to_vec();
        let output = output.to_string();
        let progress = progress.clone();

        let handler = std::thread::spawn(move || {
            let buf = BufWriter::new(File::create(format!("{output}/chunk_{index}.rbinpack")).unwrap());
            let mut writer = BinpackWriter::new(buf);
            let mut nnue = Network::default();

            for file_name in chunk {
                convert_pgn(&file_name, &mut writer, &mut nnue);
                progress.lock().unwrap().inc(1);
            }
        });
        handlers.push(handler);
    }

    for handler in handlers {
        handler.join().unwrap();
    }

    std::process::exit(0);
}

pub fn convert_pgn(file_name: &str, writer: &mut BinpackWriter, nnue: &mut Network) {
    let file = File::open(file_name).unwrap();
    let uncompressed = bzip2::read::BzDecoder::new(file);
    let bytes = BufReader::new(uncompressed).bytes().flatten().collect::<Vec<_>>();

    let mut parser = PGNTokenIterator::new(&bytes);

    let mut position = Chess::default();
    let mut start_board = Board::default();

    let mut internal_board = Board::default();
    let mut internal_entries = Vec::new();

    let mut mate_score_found = false;
    let mut skip_game = false;

    while let Some(token) = parser.next() {
        if matches!(token, Token::TagString(_) | Token::TagSymbol(_)) {
            mate_score_found = false;
        }

        match token {
            Token::TagSymbol(bytes) if bytes == b"FEN" => {
                let fen_bytes = match parser.next() {
                    Some(Token::TagString(v)) => v,
                    _ => panic!(),
                };

                start_board = Board::from_fen(&String::from_utf8_lossy(fen_bytes)).unwrap();

                internal_board = start_board.clone();
                internal_entries.clear();

                position = Fen::from_ascii(fen_bytes).unwrap().into_position(CastlingMode::Standard).unwrap();
            }
            Token::TagSymbol(bytes) if bytes == b"Termination" => {
                let reason = match parser.next() {
                    Some(Token::TagString(v)) => String::from_utf8_lossy(v).to_string(),
                    _ => panic!(),
                };

                if reason == "abandoned" {
                    skip_game = true;
                }
            }
            Token::Result(bytes) => {
                let result = match bytes {
                    b"1-0" => 2,
                    b"1/2-1/2" => 1,
                    b"0-1" => 0,
                    _ => panic!("Unexpected result: {:?}", String::from_utf8_lossy(&bytes)),
                };

                if !skip_game {
                    writer.write(&start_board, result, &internal_entries);
                }
                skip_game = false;
            }
            _ => (),
        }

        if mate_score_found {
            continue;
        }

        if let Token::Move(bytes) = token {
            let commentary = match parser.next() {
                Some(Token::Commentary(bytes)) => String::from_utf8_lossy(&bytes).to_string(),
                _ => panic!(),
            };

            let score = match commentary.split_whitespace().next().and_then(|v| v.parse::<f32>().ok()) {
                Some(_) => {
                    nnue.full_refresh(&internal_board);
                    nnue.evaluate(&internal_board)
                }
                None => {
                    mate_score_found = true;
                    continue;
                }
            };

            let san = San::from_ascii(bytes).unwrap();
            let mv = san.to_move(&position).unwrap();
            let uci_move = mv.to_uci(CastlingMode::Standard).to_string();

            let internal_move = internal_board
                .generate_all_moves()
                .iter()
                .map(|entry| entry.mv)
                .find(|m| m.to_uci(&internal_board) == uci_move)
                .unwrap();

            internal_entries.push((internal_move, score.try_into().unwrap()));
            internal_board.make_move(internal_move, |_, _, _, _| ());
            position.play_unchecked(&mv);
        }
    }
}
